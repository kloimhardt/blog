---
layout: post
title:  "Sicmutils as JavaScript library (5)"
date:   2023-02-24 06:00:01 +0100
categories: Software
---
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://storage.googleapis.com/app.klipse.tech/css/codemirror.css">

    <script>
     window.klipse_settings = {
         selector_eval_js: '.language-klipse-eval-js'
     };
    </script>
</head>

<body>
    <pre>&lt;script src=&quot;https://kloimhardt.github.io/blog/js/main.js&quot;&gt;&lt;/script&gt;</pre>

    <script src="https://kloimhardt.github.io/blog/js/main.js"></script>

    <pre>&lt;script&gt;
 var loadEnv = (name) => {
    window[name] = sicmutils.env[name];
    return name;
 }
&lt;/script&gt;</pre>

    <script>
     var loadEnv = (name) => {
         window[name] = sicmutils.env[name];
         return name;
     }
    </script>

    <pre><code class="language-klipse-eval-js">
var div = sicmutils.env._SLASH_;
var mul = sicmutils.env._STAR_;
var sub = sicmutils.env._;
var add = sicmutils.env._PLUS_;
var symbol = cljs.core.symbol;
var drv = sicmutils.env.D;
["expt", "sin", "cos", "__GT_infix", "simplify"].map(loadEnv);

var replaceMath = (txt) =>
txt.replace(/\//g,"div")
.replace(/\*/g,"mul")
.replace(/\-/g,"sub")
.replace(/\+/g,"add")
.replace(/\^/g,"expt")
.replace(/\'(\w+)/g,"symbol_$1");

var insertCommas = (txt) =>
txt.replace(/(\w+)/g,'"$1",')
.replace(/\,\s+\]/g," ]");

var makeBrackets = (txt) =>
txt.trim()
.replace(/\(/g,"[ ")
.replace(/\)/g," ],")
.replace(/,$/,"");

var textToJson = (txt) =>
JSON.parse(insertCommas(replaceMath(makeBrackets(txt))));

var swapFirst = (j) =>
j.constructor == Array
&& ["div", "mul", "sub", "add", "expt"].includes(j[1])
? [j[1], j[0]].concat(j.slice(2)).map(swapFirst)
: j.constructor == Array
? j.map(swapFirst)
: j;

var replaceD = (j) =>
j.constructor == Array
? j.map(replaceD)
: j == "D" ? "drv" : j;

var preAmble = (j) => ["__GT_infix", ["simplify", j]];

var modifyJson = (j) => preAmble(replaceD(swapFirst(j)));

var jsonToJs = (j) =>
j.constructor == Array
? jsonToJs(j[0]) + ".call(null,"  +  j.slice(1).map(jsonToJs) + ")"
: j.substring(0, 7) == "symbol_"
? 'symbol("' + j.substring(7, j.length) + '")'
: j;

var expressionToJs = (expr) =>
jsonToJs(modifyJson(textToJson(expr))); null;
    </code></pre>


    <pre>&lt;script&gt;
     var oldEval = window.eval;
     var newEval = (txt) =>
         txt[0] === "("
         ? oldEval(expressionToJs(txt))
         : oldEval(txt);
     window.eval = newEval;
&lt;/script&gt;</pre>

    <script>
     var oldEval = window.eval;
     var newEval = (txt) =>
         txt[0] === "("
         ? oldEval(expressionToJs(txt))
         : oldEval(txt);
     window.eval = newEval;
    </script>

    <pre><code class="language-klipse-eval-js">
((cos (sin 0)) + (((2 / 3) - 4) * (5 ^ 2)))
    </code></pre>

    <pre><code class="language-klipse-eval-js">
((D (3 * (sin ^ 2))) 'x)
    </code></pre>

    <pre><code class="language-klipse-eval-js">
var jsonCode = textToJson("(define (funame x) (+ x 1))")

var makeFun = (j, callBack) =>
"var " + j[1][0] + " = (" + j[1].slice(1) + ") => "
+ callBack(j[2]) +";";

makeFun(jsonCode, x=> "_" + x)
    </code></pre>

    <pre><code class="language-klipse-eval-js">
var jsonCode = textToJson("(define ((funame x) y) (+ x y))")

var makeFunFun = (j, callBack) =>
"var " + j[1][0][0] + " = (" + j[1][0].slice(1) + ") => "
+ "(" + j[1].slice(1) +") => " + callBack(j[2]) + ";";

makeFunFun(jsonCode, x=> "_" + x)
    </code></pre>

    <pre><code class="language-klipse-eval-js">
var modifyJson = (j) =>
j[0] != "define"
? preAmble(replaceD(swapFirst(j)))
: replaceD(swapFirst(j));

var jsonToJs = (j) =>
j.constructor == Array && j[0] === "define"
&& j[1][0].constructor == Array
? makeFunFun(j, jsonToJs)
:j.constructor == Array && j[0] === "define"
? makeFun(j, jsonToJs)
: j.constructor == Array
? jsonToJs(j[0]) + ".call(null,"  +  j.slice(1).map(jsonToJs) + ")"
: j.substring(0, 7) == "symbol_" // new
? 'symbol("' + j.substring(7, j.length) + '")'
: j
    </code></pre>


    <pre><code class="language-klipse-eval-js">
(define (auname x) (x + 1))
    </code></pre>

    <pre><code class="language-klipse-eval-js">
(auname 4)
    </code></pre>

    <pre><code class="language-klipse-eval-js">

(define ((buname x) y) (x + y))
    </code></pre>

    <pre><code class="language-klipse-eval-js">
((buname 4) 5)
    </code></pre>

    <pre><code class="language-klipse-eval-js">

    </code></pre>


<script src="https://storage.googleapis.com/app.klipse.tech/plugin_prod/js/klipse_plugin.min.js"></script>
</body>
</html>
