---
layout: post
title:  "Up and Compose"
date:   2023-03-20 06:00:01 +0100
categories: HamiltonMechanics
---
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://storage.googleapis.com/app.klipse.tech/css/codemirror.css">

    <script>
     window.klipse_settings = {
         selector_eval_js: '.language-klipse-eval-js'
     };
    </script>
</head>

<body>
    <p>As a follow up to the expositions in blog post <a href="https://kloimhardt.github.io/blog/software/2023/02/22/sicmutils-as-js-3.html">Sicmutils as JavaScript library (3) </a>, we include the Sicmutils library and show a simplified Scheme syntax compiler.</p>

    <pre>&lt;script src=&quot;https://kloimhardt.github.io/blog/js/main.js&quot;&gt;&lt;/script&gt;</pre>

    <script src="https://kloimhardt.github.io/blog/js/main.js"></script>

    <pre><code class="language-klipse-eval-js">
var insertCommas = (txt) =>
txt.replace(/(\w+)/g,'"$1",')
.replace(/\,\s+\]/g," ]");

var makeBrackets = (txt) =>
txt.trim()
.replace(/\(/g,"[ ")
.replace(/\)/g," ],")
.replace(/,$/,"");

var textToJson = (txt) =>
JSON.parse(insertCommas(makeBrackets(txt)));

var jsonToJs = (j) =>
j.constructor == Array
? jsonToJs(j[0]) + ".call(null,"  +  j.slice(1).map(jsonToJs) + ")"
: j;

var expressionToJs = (expr) =>
jsonToJs(textToJson(expr)) + ".toString();";
    </code></pre>

    <p>We also patch the JavaScript <code>eval</code> function.</p>

    <pre>&lt;script&gt;
     var oldEval = window.eval;
     var newEval = (txt) =>
        txt[0] === "(" && txt[txt.length - 1] != " "
        ? "add blank to code: " + txt
        : txt[0] === "("
        ? oldEval(expressionToJs(txt))
        : txt[txt.length - 1] != ";"
        ? "add ; to code: " + txt
        : oldEval(txt);
     window.eval = newEval;
&lt;/script&gt;</pre>


    <script>
     var oldEval = window.eval;
     var newEval = (txt) =>
        txt[0] === "(" && txt[txt.length - 1] != " "
        ? "add blank to code: " + txt
        : txt[0] === "("
        ? oldEval(expressionToJs(txt))
        : txt[txt.length - 1] != ";"
        ? "add ; to code: " + txt
        : oldEval(txt);
     window.eval = newEval;
    </script>

    <pre><code class="language-klipse-eval-js">
var up = sicmutils.env.up;
math_cos = Math.cos;
math_sin = Math.sin;
    </code></pre>

    <pre><code class="language-klipse-eval-js">
 up(1, 0);
    </code></pre>

    <pre><code class="language-klipse-eval-js">
up(math_cos(0), math_sin(0));
    </code></pre>

    <pre><code class="language-klipse-eval-js">
(up (math_cos 0) (math_sin 0)) 
    </code></pre>

    <pre><code class="language-klipse-eval-js">
up(math_cos, math_sin).call(null,0);
    </code></pre>

    <pre><code class="language-klipse-eval-js">
((up math_cos math_sin) 0) 
    </code></pre>

    <pre><code class="language-klipse-eval-js">
math_cos(math_sin(0));
    </code></pre>

    <pre><code class="language-klipse-eval-js">
(math_cos (math_sin 0)) 
    </code></pre>

    <pre><code class="language-klipse-eval-js">
var compose = sicmutils.env.compose;
    </code></pre>

    <pre><code class="language-klipse-eval-js">
compose(math_cos, math_sin).call(null, 0);
    </code></pre>

    <pre><code class="language-klipse-eval-js">
((compose math_cos math_sin) 0) 
    </code></pre>

<script src="https://storage.googleapis.com/app.klipse.tech/plugin_prod/js/klipse_plugin.min.js"></script>
</body>
</html>
